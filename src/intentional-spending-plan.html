<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intentional Spending Plan</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }

        .container {
            max-width: 960px;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Style for printing (hides buttons/forms) */
        @media print {

            .print\:hidden,
            .print\:hidden * {
                display: none !important;
            }

            body {
                background-color: #fff;
                margin: 0;
                padding: 0;
            }

            .container,
            .bg-white,
            #app {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
            }

            /* Ensure the content is fully visible */
            #main-content {
                display: block !important;
            }
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div id="app" class="container mx-auto">

        <!-- Status Message Box -->
        <div id="status-message"
            class="fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl hidden z-50 print:hidden"></div>

        <div class="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-purple-500">
            <h2 class="text-3xl font-extrabold mb-6 text-gray-800 flex items-center">
                <i data-lucide="bar-chart-2" class="mr-3 text-purple-500 w-7 h-7"></i>
                Intentional Spending Plan (Monthly)
            </h2>

            <div id="loading" class="text-center py-10 hidden">
                <!-- No loading needed since no remote data fetch -->
            </div>

            <div id="main-content" class="space-y-8">

                <!-- Print Button -->
                <div class="text-right pb-4 print:hidden">
                    <button id="print-plan-btn"
                        class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center float-right">
                        <i data-lucide="printer" class="w-5 h-5 mr-2"></i>
                        Print/Export PDF
                    </button>
                </div>

                <!-- Spending Summary -->
                <div id="summary-section"
                    class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center p-4 bg-purple-50 rounded-xl shadow-inner">
                    <!-- Dynamic Summary Content Here -->
                </div>

                <div id="incomeStreamsSection"></div>
                <div id="monthlyExpensesSection"></div>
                <div id="investmentsSection"></div>
                <div id="savingsGoalsSection"></div>
                <div id="guiltFreeSpendingSection"></div>

                <!-- Global Clear Button -->
                <div class="border-t pt-8 mt-8 text-center print:hidden">
                    <button id="global-clear-btn"
                        class="bg-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-red-700 transition duration-300 flex items-center mx-auto"
                        title="Danger: This will erase all your entered data.">
                        <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i>
                        Clear Entire Plan
                    </button>
                    <p class="text-xs text-red-400 mt-2">Warning: This action will reset all sections to default (zero
                        amounts). Data will not persist after closing the browser tab.</p>
                </div>
            </div>
        </div>

        {{> footer}}
    </div>

    <!-- Confirmation Modal Structure -->
    <div id="confirmation-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden print:hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4">Confirm Action</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel"
                    class="px-4 py-2 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400 transition">Cancel</button>
                <button id="modal-confirm"
                    class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        // All Firebase imports and initialization have been removed. The application now runs purely client-side.

        // --- Global State ---
        // State is initialized to empty, and defaults are merged in during rendering.
        let state = {
            incomeStreams: [],
            monthlyExpenses: [],
            guiltFreeSpending: [],
            savingsGoals: [],
            investments: [],
        };

        const FIELD_MAP = {
            incomeStreams: { title: 'Income', color: 'green' },
            monthlyExpenses: { title: 'Expenses', color: 'blue' },
            investments: { title: 'Investments', color: 'purple' },
            savingsGoals: { title: 'Savings Goals', color: 'teal' },
            guiltFreeSpending: { title: 'Guilt-Free Spending', color: 'yellow' },
        };

        // --- Utility Functions ---

        const formatCurrency = (value) => {
            const num = parseFloat(value);
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(isNaN(num) ? 0 : num);
        };

        const showUserMessage = (message, isError = true) => {
            const msgEl = document.getElementById('status-message');
            msgEl.textContent = message;
            msgEl.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
            msgEl.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            setTimeout(() => {
                msgEl.classList.add('hidden');
            }, 5000);
        };

        const getDefaults = (fieldName) => {
            switch (fieldName) {
                case 'incomeStreams': return [
                    { name: 'Wages / Salary', defaultAmount: 0 },
                    { name: 'Business Income', defaultAmount: 0 },
                    { name: 'Rental Income', defaultAmount: 0 },
                    { name: 'Side Gig / Freelance', defaultAmount: 0 },
                    { name: 'Other Income', defaultAmount: 0 },
                ];
                case 'monthlyExpenses': return [
                    { name: 'Mortgage / Rent', defaultAmount: 0 },
                    { name: 'Utilities (Water, Gas, Electric)', defaultAmount: 0 },
                    { name: 'Internet / Phone Bill', defaultAmount: 0 },
                    { name: 'Groceries', defaultAmount: 0 },
                    { name: 'Insurance (Health, Car, Home)', defaultAmount: 0 },
                    { name: 'Subscriptions (Netflix, Spotify, etc.)', defaultAmount: 0 },
                    { name: 'Installments (Tech, Furniture)', defaultAmount: 0 },
                    { name: 'Childcare / School Fees', defaultAmount: 0 },
                ];
                case 'investments': return [
                    { name: 'Retirement Account (401k/403b)', defaultAmount: 0 },
                    { name: 'IRA / Roth IRA', defaultAmount: 0 },
                    { name: 'Brokerage / Stocks', defaultAmount: 0 },
                    { name: 'HSA Contributions', defaultAmount: 0 },
                ];
                case 'savingsGoals': return [
                    { name: 'Emergency Fund', defaultAmount: 0 },
                    { name: 'Buying a House Down Payment', defaultAmount: 0 },
                    { name: 'Education Fund', defaultAmount: 0 },
                    { name: 'Wedding Fund', defaultAmount: 0 },
                    { name: 'Moving Fund', defaultAmount: 0 },
                    { name: 'Car Replacement Fund', defaultAmount: 0 },
                    { name: 'Trip / Vacation Fund', defaultAmount: 0 },
                ];
                case 'guiltFreeSpending': return [
                    { name: 'Dining Out / Takeout', defaultAmount: 0 },
                    { name: 'Entertainment (Movies, Museums, Games)', defaultAmount: 0 },
                    { name: 'Personal Products (Beauty, Clothes, Shoes)', defaultAmount: 0 },
                    { name: 'Hobbies / Wellness', defaultAmount: 0 },
                    { name: 'Gifts / Donations', defaultAmount: 0 },
                ];
                default: return [];
            }
        };

        const getIcons = (fieldName) => {
            switch (fieldName) {
                case 'incomeStreams': return { icon: 'DollarSign', color: 'green' };
                case 'monthlyExpenses': return { icon: 'Home', color: 'blue' };
                case 'investments': return { icon: 'TrendingUp', color: 'purple' };
                case 'savingsGoals': return { icon: 'PiggyBank', color: 'teal' };
                case 'guiltFreeSpending': return { icon: 'ShoppingBag', color: 'yellow' };
                default: return { icon: 'BarChart2', color: 'gray' };
            }
        };

        const mergeDataWithDefaults = (savedData, defaults) => {
            const savedMap = new Map(savedData.map(item => [item.name, item]));
            const mergedList = [];

            // 1. Process defaults (ensure all defaults are present)
            for (const def of defaults) {
                if (savedMap.has(def.name)) {
                    // Use saved data if it exists
                    mergedList.push({ ...savedMap.get(def.name), id: def.name, isDefault: true });
                    savedMap.delete(def.name);
                } else {
                    // Add default with 0 amount and a STABLE ID (the name itself)
                    mergedList.push({
                        id: def.name,
                        name: def.name,
                        amount: def.defaultAmount,
                        isDefault: true
                    });
                }
            }

            // 2. Add remaining custom items from saved data (which should have their own UUIDs)
            for (const item of savedMap.values()) {
                mergedList.push(item);
            }

            return mergedList.sort((a, b) => a.name.localeCompare(b.name));
        };

        const calculateSummary = () => {
            const incomeList = mergeDataWithDefaults(state.incomeStreams, getDefaults('incomeStreams'));
            const totalIncomeFromStreams = incomeList.reduce((acc, item) => acc + (item.amount || 0), 0);

            const totalMonthlyExpenses = state.monthlyExpenses.reduce((acc, exp) => acc + (exp.amount || 0), 0);
            const totalInvestments = state.investments.reduce((acc, inv) => acc + (inv.amount || 0), 0);
            const totalSavings = state.savingsGoals.reduce((acc, goal) => acc + (goal.amount || 0), 0);
            const totalGuiltFree = state.guiltFreeSpending.reduce((acc, exp) => acc + (exp.amount || 0), 0);

            const totalMinPayments = 0;

            const effectiveGrossMonthlyIncome = totalIncomeFromStreams;
            const totalAllocated = totalMinPayments + totalMonthlyExpenses + totalInvestments + totalSavings + totalGuiltFree;
            const remainingIncome = effectiveGrossMonthlyIncome - totalAllocated;

            return {
                totalIncomeFromStreams, totalMonthlyExpenses, totalInvestments, totalSavings, totalGuiltFree,
                totalAllocated, remainingIncome, effectiveGrossMonthlyIncome
            };
        };

        // --- DOM Rendering Functions ---

        const renderSummary = () => {
            const summary = calculateSummary();
            const summaryEl = document.getElementById('summary-section');
            const remainingColor = summary.remainingIncome >= 0 ? 'text-green-600' : 'text-red-600';

            summaryEl.innerHTML = `
                <div class="border-r pr-2">
                    <p class="text-xs text-gray-600 font-medium">Total Income</p>
                    <p class="text-xl font-bold text-purple-700">${formatCurrency(summary.effectiveGrossMonthlyIncome)}</p>
                </div>
                <div class="border-r pr-2">
                    <p class="text-xs text-gray-600 font-medium">Total Allocated</p>
                    <p class="text-xl font-bold text-blue-700">${formatCurrency(summary.totalAllocated)}</p>
                </div>
                <div class="col-span-2 p-1 rounded-lg">
                    <p class="text-xs text-gray-600 font-medium">Remaining Guilt-Free Income</p>
                    <p class="text-2xl font-black ${remainingColor}">${formatCurrency(summary.remainingIncome)}</p>
                </div>
            `;
        };

        const renderSpendingList = (fieldName, title) => {
            const { icon, color } = getIcons(fieldName);
            const items = state[fieldName];
            const defaults = getDefaults(fieldName);
            const displayItems = mergeDataWithDefaults(items, defaults);
            const total = displayItems.reduce((acc, item) => acc + (item.amount || 0), 0);
            const sectionEl = document.getElementById(fieldName + 'Section');

            // Build item list HTML
            const itemListHtml = displayItems.map(item => {
                const isDefault = item.isDefault || defaults.some(d => d.name === item.name && !item.id);
                const disabledAttr = isDefault ? 'disabled' : '';
                const nameInputClass = isDefault ? 'text-gray-600 font-medium' : 'focus:ring-1 focus:ring-gray-300';

                return `
                    <li class="flex flex-col sm:flex-row items-center justify-between bg-white p-3 rounded-lg border border-gray-200 shadow-sm transition duration-150 hover:shadow-md">
                        <input
                            type="text"
                            value="${item.name}"
                            data-id="${item.id}"
                            data-field="${fieldName}"
                            data-action="update-name"
                            class="flex-grow p-1 text-base font-medium bg-transparent focus:outline-none rounded-md ${nameInputClass}"
                            placeholder="Category Name"
                            ${disabledAttr}
                        />
                        <div class="flex items-center space-x-2 mt-2 sm:mt-0 print:hidden">
                            <input
                                type="number"
                                value="${item.amount === 0 ? '' : item.amount}"
                                data-id="${item.id}"
                                data-field="${fieldName}"
                                data-action="update-amount"
                                placeholder="0.00"
                                class="w-28 text-right p-1 border rounded-md focus:border-${color}-400 transition"
                                step="0.01"
                                min="0"
                            />
                            <button data-id="${item.id}" data-field="${fieldName}" data-action="delete" class="text-gray-400 hover:text-red-500 p-1 rounded-full transition duration-300" title="Delete Item">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <span class="font-semibold text-base sm:ml-4 mt-2 sm:mt-0 text-right w-28 print:block hidden">${formatCurrency(item.amount)}</span>
                    </li>
                `;
            }).join('');

            // Build section HTML
            sectionEl.innerHTML = `
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-semibold flex items-center text-${color}-600">
                            <i data-lucide="${icon}" class="mr-2 text-${color}-500 w-5 h-5"></i>${title}
                        </h3>
                        <button 
                            data-field="${fieldName}" 
                            data-action="clear-section" 
                            class="text-sm text-red-500 hover:text-red-700 font-medium transition duration-300 flex items-center p-1 rounded-md border border-transparent hover:border-red-500 print:hidden" 
                            title="Clear all entries in this section">
                            <i data-lucide="x-circle" class="w-4 h-4 mr-1"></i>
                            Clear Section
                        </button>
                    </div>
                    
                    <ul class="space-y-2 mb-4">
                        ${itemListHtml}
                    </ul>

                    <!-- Custom Item Form -->
                    <form data-field="${fieldName}" data-action="add-item" class="flex flex-col sm:flex-row gap-2 mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200 print:hidden">
                        <input type="text" name="name" placeholder="Add Custom Item" class="flex-grow p-2 border border-gray-300 rounded-lg text-sm" required />
                        <input type="number" name="amount" placeholder="Amount ($)" class="w-full sm:w-32 p-2 border border-gray-300 rounded-lg text-sm" step="0.01" min="0" required />
                        <button type="submit" class="bg-${color}-600 text-white p-2 rounded-lg hover:bg-${color}-700 transition duration-300 flex items-center justify-center" title="Add Custom Item">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i>
                        </button>
                    </form>

                    <p class="text-right font-bold mt-2 text-lg">Total ${title}: <span class="text-${color}-700">${formatCurrency(total)}</span></p>
                </div>
            `;
            // Re-render Lucide icons after HTML update
            lucide.createIcons();
        };

        const renderApp = () => {
            renderSummary();
            renderSpendingList('incomeStreams', FIELD_MAP.incomeStreams.title);
            renderSpendingList('monthlyExpenses', FIELD_MAP.monthlyExpenses.title);
            renderSpendingList('investments', FIELD_MAP.investments.title);
            renderSpendingList('savingsGoals', FIELD_MAP.savingsGoals.title);
            renderSpendingList('guiltFreeSpending', FIELD_MAP.guiltFreeSpending.title);

            document.getElementById('main-content').classList.remove('hidden');
        };

        // --- Confirmation Modal Functions ---
        let pendingAction = null;

        const showConfirmationModal = (title, message, callback) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('confirmation-modal').classList.remove('hidden');
            pendingAction = callback;
        };

        const hideConfirmationModal = () => {
            document.getElementById('confirmation-modal').classList.add('hidden');
            pendingAction = null;
        };

        // --- Core Data Manipulation Logic (Client-Only) ---

        const updateItemInList = (fieldName, id, updates) => {
            const list = state[fieldName];
            const itemToUpdateIndex = list.findIndex(item => item.id === id || item.name === id); // Check both UUID and Name (for defaults)
            let updatedList = [...list];

            const defaults = getDefaults(fieldName);

            if (itemToUpdateIndex !== -1) {
                // Item already exists in state, update it
                updatedList[itemToUpdateIndex] = { ...updatedList[itemToUpdateIndex], ...updates };
            } else {
                // Default item being modified for the first time
                const defaultItem = defaults.find(d => d.name === id);
                if (defaultItem) {
                    // Save the default item with its name as the ID for stability
                    const newItem = { id: id, name: id, amount: updates.amount, isDefault: true };
                    updatedList.push(newItem);
                } else {
                    console.error("Attempted to update item not found in state or defaults:", id);
                    return;
                }
            }

            state[fieldName] = updatedList;
            renderApp();
        };

        const deleteItemFromList = (fieldName, id) => {
            let list = state[fieldName];

            // 1. Try to filter out by UUID (custom item)
            const filteredList = list.filter(item => item.id !== id);

            let finalState;

            if (filteredList.length !== list.length) {
                // Item was a custom item, just use the filtered list
                finalState = filteredList;
            } else {
                // Item must be a default item (id is name), so set its amount to 0
                const itemToZeroIndex = list.findIndex(item => item.name === id);
                if (itemToZeroIndex !== -1) {
                    list[itemToZeroIndex].amount = 0;
                    // Filter out the zeroed default item
                    finalState = list.filter(item => (item.amount || 0) > 0 || item.isCustom);
                } else {
                    // Should not happen, but if item is not found by UUID or Name, do nothing
                    return;
                }
            }

            state[fieldName] = finalState;
            renderApp();
        };

        const addItemToList = (fieldName, name, amount) => {
            const parsedAmount = parseFloat(amount);
            if (isNaN(parsedAmount) || parsedAmount < 0) { showUserMessage("Please enter a valid amount."); return; }

            // Check for duplicate names against current state and defaults
            const defaults = getDefaults(fieldName).map(d => d.name);
            if (defaults.includes(name) || state[fieldName].some(item => item.name === name)) {
                showUserMessage(`Item named "${name}" already exists or is a default category.`);
                return;
            }

            const newItem = { id: crypto.randomUUID(), name: name, amount: parsedAmount, isCustom: true };
            const updatedList = [...state[fieldName], newItem];

            state[fieldName] = updatedList;
            renderApp();
            showUserMessage(`Added custom item: ${name}.`, false);
        };

        const clearSectionData = (fieldName) => {
            const title = FIELD_MAP[fieldName].title;

            showConfirmationModal(
                `Clear ${title}?`,
                `This will reset all data in the "${title}" section to zero. Are you sure you want to proceed?`,
                () => {
                    state[fieldName] = []; // Clear local state
                    showUserMessage(`${title} section cleared successfully.`, false);
                    renderApp();
                }
            );
        };

        const clearAllData = () => {
            showConfirmationModal(
                `Clear Entire Plan?`,
                `DANGER: This will clear ALL entries from Income, Expenses, Savings, Investments, and Guilt-Free Spending. This cannot be undone (and is not saved to a database). Are you absolutely sure?`,
                () => {
                    const fields = Object.keys(FIELD_MAP);
                    fields.forEach(fieldName => {
                        state[fieldName] = [];
                    });
                    showUserMessage("Entire Spending Plan cleared successfully and reset to defaults.", false);
                    renderApp();
                }
            );
        };


        // --- Event Delegation ---

        const handleInputEvent = (e) => {
            const target = e.target;
            const action = target.getAttribute('data-action');
            const id = target.getAttribute('data-id');
            const fieldName = target.getAttribute('data-field');

            if (!id || !fieldName) return;

            if (action === 'update-amount' && e.type === 'change') {
                const amount = target.value === '' ? 0 : parseFloat(target.value);
                if (!isNaN(amount) && amount >= 0) {
                    updateItemInList(fieldName, id, { amount });
                }
            } else if (action === 'update-name' && e.type === 'change') {
                if (target.value.trim() !== '') {
                    // Only update name for custom items, defaults are disabled
                    updateItemInList(fieldName, id, { name: target.value.trim() });
                }
            }
        };

        const handleButtonClick = (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const action = target.getAttribute('data-action');
            const id = target.getAttribute('data-id');
            const fieldName = target.getAttribute('data-field');

            if (action === 'delete') {
                e.preventDefault();
                deleteItemFromList(fieldName, id);
            } else if (action === 'clear-section') {
                e.preventDefault();
                clearSectionData(fieldName);
            }
        };

        const handleFormSubmit = (e) => {
            if (e.target.getAttribute('data-action') === 'add-item') {
                e.preventDefault();
                const fieldName = e.target.getAttribute('data-field');
                const name = e.target.elements.name.value.trim();
                const amount = e.target.elements.amount.value;

                if (name && amount) {
                    addItemToList(fieldName, name, amount);
                    e.target.reset(); // Clear form inputs
                } else {
                    showUserMessage("Please fill out both name and amount.");
                }
            }
        };

        // --- Initialization (Client-Only) ---

        document.addEventListener('DOMContentLoaded', () => {
            // Set up event listeners (delegated)
            document.getElementById('main-content').addEventListener('change', handleInputEvent);
            document.getElementById('main-content').addEventListener('click', handleButtonClick);
            document.getElementById('main-content').addEventListener('submit', handleFormSubmit);

            // Global Clear Button Listener
            document.getElementById('global-clear-btn').addEventListener('click', clearAllData);

            // Print Button Listener
            document.getElementById('print-plan-btn').addEventListener('click', () => {
                window.print();
            });

            // Modal Listeners
            document.getElementById('modal-cancel').addEventListener('click', hideConfirmationModal);
            document.getElementById('modal-confirm').addEventListener('click', () => {
                if (pendingAction) {
                    pendingAction();
                }
                hideConfirmationModal();
            });

            // Start the application rendering immediately
            renderApp();
        });
    </script>
</body>

</html>